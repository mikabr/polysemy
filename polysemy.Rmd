---
title: "Polysemy Analysis"
author: "Mika Braginsky and Dan Yurovsky"
date: "February 12, 2015"
output:
  html_document:
  highlight: tango
theme: spacelab
---
  
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, message=FALSE, warning=FALSE)
```

***

## Data Loading
  
  Load required libraries.
```{r libraries, cache=FALSE}
source("~/Documents/projects/Ranalysis/useful.R")
library(arm)
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(RMySQL)
library(stringr)
```

Load in Wordbank data.
```{r database, cache=FALSE}
# open database connection
wordbank <- src_mysql(dbname="wordbank", host="54.149.39.46",
                      user="wordbank", password="wordbank")

# load tables
wordmapping.table <- tbl(wordbank, "common_wordmapping")
instruments.table <- tbl(wordbank, "common_instrumentsmap")
english.ws.table <- tbl(wordbank, "instruments_english_ws")
```

Get item data.
```{r item_data}
# get item info
mapping <- as.data.frame(wordmapping.table)

# get instrument info
instruments <- as.data.frame(instruments.table) %>%
  rename(instrument_id = id)

# join items and instruments together
items <- left_join(mapping, instruments) %>%
  mutate(language = factor(language, levels = c("Norwegian", "English", "Danish", "Spanish")))
```

```{r poly_data}
instrument.items <- items %>% 
  filter(language == "English", form == "WS", type == "word") %>%
  select(item) %>%
  mutate(stritem = str_replace(item, "\\.", "_"))

instrument.data <- as.data.frame(english.ws.table) %>%
  rename(id = basetable_ptr_id) %>% # Rename the id
  gather(item, value, -id) %>% # Arrange in longform
  mutate(stritem = str_replace(item, "item_", "")) %>%
  select(-item) # Strip off item_ 

data <- left_join(instrument.data, instrument.items)
poly.data <- data %>%
  filter(grepl("\\.",item)==TRUE) %>%
  select(-stritem)
```

```{r conditionals}
all.pairs <- expand.grid(item = unique(poly.data$item),pair = unique(poly.data$item))

item.data <- left_join(poly.data,all.pairs,by = c("item")) %>%
  rename(item.value = value)

pair.data <- item.data %>%
  mutate(pair.tmp = item,
         item = pair,
         pair = pair.tmp) %>%
  select(-pair.tmp) %>%
  rename(pair.value = item.value) %>%
  arrange(id,item)

all.data <- inner_join(item.data, pair.data)

and.data <- all.data %>%
  rowwise() %>%
  mutate(both = item.value == "produces" & pair.value == "produces")

summary.data <- and.data %>%
  group_by(item, pair) %>%
  summarise(prop.both = sum(both,na.rm=TRUE) / length(both))

match <- summary.data %>%
  filter(item == pair) %>%
  ungroup() %>%
  select(-item) %>%
  rename(prop.pair = prop.both)

cond.data <- left_join(summary.data, match) %>%
  mutate(conditional = prop.both / prop.pair) %>%
  filter(item != pair) %>%
  separate(item, c("item.word", "item.category"), "\\.") %>%
  mutate(item = paste(item.word, " (", item.category, ")", sep="")) %>%
  separate(pair, c("pair.word", "pair.category"), "\\.") %>%
  mutate(pair = paste(pair.word, " (", pair.category, ")", sep="")) %>%
  mutate(same = factor(ifelse(item.word == pair.word,
                              "same word", "different word"))) %>%
  select(item, pair, same, conditional)

means.data <- cond.data %>%
  group_by(item) %>%
  summarise(mean = mean(conditional),
            ci.low = ci.low(conditional),
            ci.high = ci.high(conditional))

cond.mean.data <- left_join(cond.data, means.data, by="item") %>%
  mutate(item = factor(item))
```

```{r plot, fig.width=10, fig.height=6}
quartz(width=8, height=6)
ggplot(cond.mean.data, aes(x=item, y=conditional, colour=same)) +
  geom_point(aes(size=same)) +
  scale_size_discrete(range = c(1,3)) +
  geom_errorbar(aes(x=item, ymax=mean+ci.high, ymin=mean-ci.low, width=0.3)) +
  geom_vline(aes(xintercept = seq(2.5,length(levels(item))+0.5,2)),
             linetype = "dashed", colour="gray") +
  xlab("") + 
  ylab("Conditional Probabilities") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none")
```